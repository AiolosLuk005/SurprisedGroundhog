<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Surprised Groundhog · V1.01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* 目录选择弹窗 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;z-index:9999}
    .modal-content{width:760px;max-width:92vw;margin:10vh auto;background:#fff;border-radius:10px;
      box-shadow:0 16px 48px rgba(0,0,0,.18);padding:10px 12px}
    .modal-head,.modal-foot{display:flex;align-items:center;justify-content:space-between;padding:6px 4px}
    .modal-body{max-height:64vh;overflow:auto;padding:6px 2px}
    #dirList{list-style:none;margin:0;padding:0}
    #dirList li{padding:8px 10px;border-bottom:1px solid #f0f0f0;cursor:pointer}
    #dirList li:hover{background:#f7f7f7}
  </style>

  <style>
  /* 全屏加载遮罩 */
  .loader {
    position: fixed; inset: 0;
    display: none; align-items: center; justify-content: center;
    background: rgba(255,255,255,.65);
    z-index: 99999; text-align: center;
  }
  .loader.show { display: flex; }

  /* 旋转圆圈（默认） */
  .spinner{
    width: 44px; height: 44px;
    border: 4px solid #e5e7eb;
    border-top-color: #111827;
    border-radius: 50%;
    animation: spin .9s linear infinite;
    margin: 12px auto;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* 沙漏 */
  .spinner.hourglass{
    width: 24px; height: 24px; border:0; position:relative;
  }
  .spinner.hourglass:before, .spinner.hourglass:after{
    content:""; position:absolute; left:0; right:0; margin:auto; width:0; height:0;
    border-left:12px solid transparent; border-right:12px solid transparent;
    animation: flip 1.2s infinite;
  }
  .spinner.hourglass:before{ top:0; border-bottom:14px solid #111827; }
  .spinner.hourglass:after{ bottom:0; border-top:14px solid #111827; animation-delay:.6s; }
  .loading-text { font-size: 12px; color:#444; }

  /* 确认 / 预览 / 设置 / 登录 弹窗 */
  .confirm-modal, .preview-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; z-index: 10000;
    align-items: center; justify-content: center;
  }
  .confirm-modal-content, .preview-modal-content {
    background: #fff; padding: 20px; border-radius: 8px; max-width: 920px; width: 92vw;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: left;
  }
  .preview-content { max-width: 100%; max-height: 80vh; overflow: auto; }
  .preview-content img, .preview-content video { max-width: 100%; height: auto; }

  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .row-inline { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .section-title{ font-weight:600; margin:10px 0 6px; }
  .small-muted{ color:#666; font-size:12px; }
  </style>
  </head>
<body data-user="{{ session.get('user', '') }}">
  <div class="topbar">
    <div class="topbar-left">
      <img class="logo" src="/static/logo.png" alt="logo">
      <h2 class="brand">Surprised Groundhog · V1.01</h2>
    </div>
    <div id="userTools"></div>
  </div>

  <div class="row">
    <label for="category">档案种类：</label>
    <select id="category">
      <option value="TEXT">文字档案</option>
      <option value="DATA">数据档案</option>
      <option value="SLIDES">简报档案</option>
      <option value="PDF">PDF 档案</option>
      <option value="ARCHIVE">压缩档案</option>
      <option value="IMAGE">图片档案</option>
      <option value="VIDEO">视频档案</option>
      <option value="AUDIO">音频档案</option>
    </select>

    <label for="types">档案类型（可多选）：</label>
    <select id="types" multiple size="6" style="min-width: 160px;"></select>

    <label for="dir">扫描目录：</label>
    <input id="dir" type="text" value="{{ default_dir }}" placeholder="请选择要扫描的目录…" style="min-width: 420px;">
    <button class="btn" id="pickDir">选择目录</button>

    <label class="pill"><input id="hash" type="checkbox" {% if enable_hash_default %}checked{% endif %}> 计算 SHA256</label>
    <label class="pill"><input id="recur" type="checkbox" checked> 包含子文件夹</label>

    <label>分页：</label>
    <input id="page_size" type="number" value="{{ page_size_default }}" min="10" max="10000">
    <button class="btn" id="scanBtn">开始扫描</button>
    <span id="count" class="muted right">未扫描</span>
  </div>

  <div class="toolbar" id="mainToolbar">
    <input id="q" type="text" placeholder="搜索（文件名/扩展名/路径）" style="min-width:280px;">
    <input id="kwFilter" type="text" placeholder="按关键词筛选" style="min-width:160px;">
    <button class="btn" id="kwFilterBtn">筛选</button>
    <button class="btn" id="exportBtn">导出 CSV</button>
    <button class="btn" id="importBtn">导入 MySQL</button>

    <!-- 可选：关键词筛选（如果不用可忽略，JS已做可选绑定） -->
    <input id="kwFilter" type="text" placeholder="按关键词筛选" style="min-width:180px;">
    <button class="btn btn-sm" id="kwFilterBtn">筛选</button>
    <input id="kw_len" type="number" min="1" max="200" value="50" style="width:70px" title="关键词最大长度">
  </div>

  <div class="toolbar" id="kwBlock">
    <label>关键词长度：</label>
    <input id="kw_len" type="number" value="50" min="1" max="200" style="width:80px;">
    <button class="btn" id="genKwBtn">提取关键词</button>
    <button class="btn" id="clearKwBtn">清除关键词</button>
  </div>

  <div class="toolbar" id="moveBlock">
    <button class="btn" id="applyMoveBtn">批量移动</button>
  </div>

  <div class="toolbar" id="renameBlock">
    <button class="btn" id="applyRenameBtn">批量重命名</button>
  </div>

  <div class="toolbar" id="deleteBlock">
    <button class="btn" id="applyDeleteBtn">批量删除</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:42px;">选</th>
        <th>文件名</th>
        <th>完整路径</th>
        <th>扩展名</th>
        <th>类别</th>
        <th>大小（kB）</th>
        <th>修改时间</th>
        <th>关键词</th>
        <th>移动目标</th>
        <th>重命名为</th>
        <th>预览</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="row">
    <button class="btn" id="prev">上一页</button>
    <span id="pageinfo" class="muted"></span>
    <button class="btn" id="next">下一页</button>
  </div>

  <!-- 目录选择弹窗 -->
  <div id="dirModal" class="modal">
    <div class="modal-content">
      <div class="modal-head">
        <strong>选择目录</strong>
        <button class="btn btn-sm" id="dirClose">关闭</button>
      </div>
      <div class="modal-body">
        <div class="row" style="padding:0 0 10px 0;">
          <button class="btn btn-sm" id="dirUp">上一级</button>
          <span id="dirHere" class="small"></span>
        </div>
        <ul id="dirList"></ul>
      </div>
      <div class="modal-foot">
        <button class="btn" id="dirOk">使用此目录</button>
      </div>
    </div>
  </div>

  <!-- 确认弹窗 -->
  <div id="confirmModal" class="confirm-modal" style="display:none;">
    <div class="confirm-modal-content">
      <p id="confirmMessage"></p>
      <div style="margin-top: 20px; text-align:center;">
        <button class="btn" id="confirmOk">确认</button>
        <button class="btn" id="confirmCancel">取消</button>
      </div>
    </div>
  </div>

  <!-- 预览弹窗 -->
  <div id="previewModal" class="preview-modal" style="display:none;">
    <div class="preview-modal-content">
      <div class="modal-head">
        <strong id="previewTitle"></strong>
        <button class="btn btn-sm" id="previewClose">关闭</button>
      </div>
      <div id="previewContent" class="preview-content"></div>
    </div>
  </div>

  <!-- 登录弹窗 -->
  <div id="loginModal" class="confirm-modal" style="display:none;">
    <div class="confirm-modal-content">
      <p><strong>管理员登录</strong></p>
      <div style="margin-top: 10px;">
        <input id="loginUser" placeholder="用户名" style="margin-bottom:8px;width: 80%;"><br>
        <input id="loginPass" type="password" placeholder="密码" style="width: 80%;">
      </div>
      <div style="margin-top: 20px; text-align:center;">
        <button class="btn" id="loginConfirm">登录</button>
        <button class="btn" id="loginCancel">取消</button>
      </div>
    </div>
  </div>

  <!-- 设置弹窗（含主题、AI供应商、功能开关） -->
  <div id="settingsModal" class="confirm-modal" style="display:none;">
    <div class="confirm-modal-content">
      <div class="modal-head">
        <strong>系统设置</strong>
        <button class="btn btn-sm" id="settingsClose">关闭</button>
      </div>
      <div class="modal-body">
        <div>
          <div class="section-title">界面主题</div>
          <div class="row-inline">
            <label class="pill"><input type="radio" name="theme" value="light"> 亮色调</label>
            <label class="pill"><input type="radio" name="theme" value="dark"> 暗色调</label>
            <label class="pill"><input type="radio" name="theme" value="system" checked> 跟随系统</label>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <div class="section-title">AI 设置</div>
          <div class="grid-2">
            <div>
              <label>AI 供应商：</label>
              <select id="aiProvider" style="min-width:180px;">
                <option value="ollama">Ollama（本地）</option>
                <option value="chatgpt">OpenAI / ChatGPT</option>
                <option value="deepseek">DeepSeek</option>
              </select>
            </div>
            <div>
              <label>API Key：</label>
              <input id="apiKey" type="password" placeholder="如使用远程 AI，请填写 API Key" style="min-width:260px;">
            </div>
          </div>
          <div class="small-muted">说明：本地 Ollama 不需要 API Key；远程 AI 需要。</div>
        </div>

        <div style="margin-top: 12px;">
          <div class="section-title">功能权限开关</div>
          <div class="feature-grid">
            <div>
              <label class="pill"><input type="checkbox" id="feat_text" checked> 文字类型</label>
              <label class="pill"><input type="checkbox" id="feat_data" checked> 数据类型</label>
              <label class="pill"><input type="checkbox" id="feat_slides" checked> 简报类型</label>
              <label class="pill"><input type="checkbox" id="feat_pdf" checked> PDF 类型</label>
              <label class="pill"><input type="checkbox" id="feat_archive" checked> 压缩类型</label>
              <label class="pill"><input type="checkbox" id="feat_image" checked> 图片类型</label>
              <label class="pill"><input type="checkbox" id="feat_video"> 视频类型</label>
              <label class="pill"><input type="checkbox" id="feat_audio"> 音频类型</label>
            </div>
            <div>
              <label class="pill"><input type="checkbox" id="feat_ai_keywords" checked> AI 关键词提取</label>
              <label class="pill"><input type="checkbox" id="feat_move" checked> 移动</label>
              <label class="pill"><input type="checkbox" id="feat_rename" checked> 重命名</label>
              <label class="pill"><input type="checkbox" id="feat_delete" checked> 删除</label>
              <label class="pill"><input type="checkbox" id="feat_image_caption"> 图像反向提示词</label>
              <label class="pill"><input type="checkbox" id="feat_video_preview"> 视频预览</label>
              <label class="pill"><input type="checkbox" id="feat_audio_preview"> 音频预览</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-foot" style="justify-content:flex-end;">
        <button class="btn" id="settingsSave">保存设置</button>
      </div>
    </div>
  </div>

  <!-- 全局加载层 -->
  <div id="loading" class="loader" aria-hidden="true">
    <div class="spinner hourglass"></div>
    <div class="loading-text">正在处理，请稍候…</div>
  </div>

  <!-- 带版本号避免缓存 -->
  <script src="/static/app_classic.js?v=20250820b"></script>
</body>
</html>
